<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Energy Efficiency Calculator</title>
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        /* Hide spinner buttons for number inputs */
        input[type=number]::-webkit-inner-spin-button, 
        input[type=number]::-webkit-outer-spin-button { 
            -webkit-appearance: none;
            margin: 0;
        }
        input[type=number] {
            -moz-appearance: textfield;
        }
    </style>
</head>
<body>
    <div class="container mt-5">
        <h2 class="mb-4">Energy Efficiency Calculator</h2>
        <div class="row">
            <div class="col-md-3 mb-3">
                <label for="scenario" class="form-label">Scenario</label>
                <select class="form-select" id="scenario" onchange="changeScenario()">
                    <option value="1">Battery Only NO PV</option>
                    <option value="2">Battery + PV 1</option>
                    <option value="3">Battery + PV 2</option>
                </select>
            </div>
        </div>

        
        <form id="efficiencyForm">
            <!-- Efficiency Parameters Section -->
            <div class="card mb-4">
                <div class="card-header">
                    <h5 class="mb-0">System Parameters</h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <h5 class="mb-3">Inveter Parameters</h5>
                        <div class="row">
                            <div class="col-md-3">
                                <div class="mb-3">
                                    <label for="inverterEfficiency" class="form-label">η inverter</label>
                                    <input type="number" class="form-control text-end" id="inverterEfficiency" value="0.93" step="0.01">
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="mb-3">
                                    <label for="inverterPrice" class="form-label">Price</label>
                                    <div class="input-group">
                                        <input type="number" class="form-control text-end" id="inverterPrice" value="1000" step="1">
                                        <span class="input-group-text">€</span>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <h5 class="mb-3">Battery Parameters</h5>
                        <div class="row">
                            <div class="col-md-3">
                                <div class="mb-3">
                                    <label for="batteryEfficiency" class="form-label">η battery</label>
                                    <input type="number" class="form-control text-end" id="batteryEfficiency" value="0.95" max="1" step="0.01">
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="mb-3">
                                    <label for="batteryCapacity" class="form-label">Capacity</label>

                                    <div class="input-group">
                                        <input type="number" class="form-control text-end" id="batteryCapacity" value="10" step="0.1">
                                        <span class="input-group-text">kWh</span>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="mb-3">
                                    <label for="batteryPrice" class="form-label">Price</label>
                                    <div class="input-group">
                                        <input type="number" class="form-control text-end" id="batteryPrice" value="2000" step="1">
                                        <span class="input-group-text">€</span>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <h5 class="mb-3">Other System Parameters</h5>
                        <div class="row">
                            <div class="col-md-3">
                                <div class="mb-3">
                                    <label for="wiringEfficiency" class="form-label">η rest of the system</label>
                                    <input type="number" class="form-control text-end" id="wiringEfficiency" value="0.99" step="0.01">
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="mb-3">
                                    <label for="otherCost" class="form-label">Other Cost</label>
                                    <div class="input-group">
                                        <input type="number" class="form-control text-end" id="otherCost" value="500" step="1">
                                        <span class="input-group-text">€</span>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <h5 class="mb-3">System Usage Parameters</h5>
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="systemUsageFactor" class="form-label">System Usage Factor %</label>
                                    <div class="col-md-6">
                                        <div class="input-group">
                                            <input type="number" class="form-control text-end" id="systemUsageFactor" value="90" step="1">
                                            <span class="input-group-text">%</span>
                                        </div>
                                    </div>
                                    
                                    <small class="form-text text-muted">How much each day the system is charged / discharged</small>
                                </div>
                            </div>
                        </div>

                        <h5 class="mb-3">Energy Cost Parameters</h5>
                        <div class="row">
                            <div class="col-md-4">
                                <div class="mb-3">
                                    <label for="nightCost" class="form-label">Night Cost</label>
                                    <div class="input-group">
                                        <input type="number" class="form-control text-end" id="nightCost" value="0.14301" step="1">
                                        <span class="input-group-text">€</span>
                                    </div>
                                    <small class="form-text text-muted">In action from 23pm to 8am</small>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="mb-3">
                                    <label for="dailyCost" class="form-label">Daily Cost</label>
                                    <div class="input-group">
                                        <input type="number" class="form-control text-end" id="dailyCost" value="0.26378" step="1">
                                        <span class="input-group-text">€</span>
                                    </div>
                                    <small class="form-text text-muted">In action from 8am to 23pm</small>
                                </div>
                            </div>
                            <!--
                            <div class="col-md-4">
                                <div class="mb-3">
                                    <label for="peakCost" class="form-label">Peak Cost</label>
                                    <input type="number" class="form-control" id="peakCost" value="0.26378">
                                    <small class="form-text text-muted">In action from 17pm to 19pm, if 0 than daily cost is used</small>
                                </div>
                            </div>
                            -->
                        </div>
                    </div>
                </div>
            </div>

            <form id="pvForm">
                <!-- Efficiency Parameters Section -->
                <div class="card mb-4">
                    <div class="card-header">
                        <h5 class="mb-0">Green Energy Parameters</h5>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label for="avgDailyProduction" class="form-label">AVG Daily Production</label>
                                        <div class="input-group">
                                            <input type="number" class="form-control text-end" id="avgDailyProduction" value="2.46" step="1">
                                            <span class="input-group-text">kWH</span>
                                        </div>
                                        <small class="form-text text-muted">a 1kWp system will produce 0.9MWh per year, so 0.9/365 = 2.46 kWh per day</small>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label for="pvPrice" class="form-label">Price</label>
                                        <div class="input-group">
                                            <input type="number" class="form-control text-end" id="pvPrice" value="0" step="1">
                                            <span class="input-group-text">€</span>
                                        </div>
                                        <small class="form-text text-muted">If you want to simulate ONLY the battery ROI leave to 0!<br>Each 1kWp system will cost around 1500€ for small systems</small>
                                    </div>
                                </div>
                            </div>
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label for="pvBuffering" class="form-label">Buffering needed (%)</label>
                                        <div class="input-group">
                                            <input type="number" class="form-control text-end" id="pvBuffering" value="80" step="1">
                                            <span class="input-group-text">%</span>
                                        </div>
                                        <small class="form-text text-muted">How much energy is needed to be stored in the battery, so can be used later?</small>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <small class="form-text text-muted">We can even simulate impossibly optimal scenario, where the vast majority of the energy is used to charge the battery.<br>
                                            It is extremely unlikely because will imply that all the energy stored in the night is used (very early in the morning), and also the daily production is used (in the evening). <br>
                                            This is basically doubling the economic efficiency, as you use the battery twice a day.
                                        </small>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </form>

            <button type="submit" class="btn btn-primary" onclick="calculate()">Calculate</button>
            

            <!-- Energy Calculations Section -->
            <div class="card mb-4 mt-4">
                <div class="card-header">
                    <h5 class="mb-0">Energy Calculations</h5>
                </div>
                <div class="card-body">
                <h5 class="mb-3">Remarks</h5>    
                    <div class="row">
                        <div class="col-md-12">
                            <div class="mb-12">
                                <small class="form-text text-muted">
                                    XXX
                                    <br>&nbsp;
                                </small>
                            </div>
                        </div>
                    </div>
                <h5 class="mb-3">Efficiency</h5>
                    <div class="row">
                        <div class="col-md-3">
                            <div class="mb-3">
                                <label for="singleTripEfficiency" class="form-label">η Single Trip</label>
                                <input readonly class="form-control text-end" id="singleTripEfficiency" readonly>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="mb-3">
                                <label for="roundTripEfficiency" class="form-label">η Round Trip</label>
                                <input readonly class="form-control text-end" id="roundTripEfficiency" readonly>
                            </div>
                        </div>
                    </div>
                
                        <div class="row">
                            <div class="col-md-3">
                                <div class="mb-3">
                                    <label for="energyToLoad" class="form-label">Energy To Load</label>
                                    <div class="input-group">
                                        <input readonly class="form-control text-end" id="energyToLoad" readonly>
                                        <span class="input-group-text">kWH</span>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="mb-3">
                                    <label for="costToLoad" class="form-label">Cost To Load</label>
                                    <div class="input-group">
                                        <input readonly class="form-control text-end" id="costToLoad" readonly>
                                        <span class="input-group-text">€</span>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="row">
                            <div class="col-md-3">
                                <div class="mb-3">
                                    <label for="usableEnergy" class="form-label">Usable Energy</label>
                                    <div class="input-group">
                                        <input readonly class="form-control text-end" id="usableEnergy" readonly>
                                        <span class="input-group-text">kWH</span>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="mb-3">
                                    <label for="valueUsableEnergy" class="form-label">Value</label>
                                    <div class="input-group">
                                        <input readonly class="form-control text-end" id="valueUsableEnergy" readonly>
                                        <span class="input-group-text">€</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <h5 class="mb-3"> PV Calculations</h5>
                        <div class="row">
                            <div class="col-md-3">
                                <div class="mb-3">
                                    <label for="bufferedEnergy" class="form-label">Stored Energy</label>
                                    <div class="input-group">
                                        <input readonly class="form-control text-end" id="bufferedEnergy" readonly>
                                        <span class="input-group-text">kWh</span>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="mb-3">
                                    <label for="usableBufferedEnergy" class="form-label">Usable Energy</label>
                                    <div class="input-group">
                                        <input readonly class="form-control text-end" id="usableBufferedEnergy" readonly>
                                        <span class="input-group-text">kWh</span>
                                    </div>
                                </div>
                            </div>

                            <div class="col-md-3">
                                <div class="mb-3">
                                    <label for="bufferedEnergyValue" class="form-label">Buffered Energy Value</label>
                                    <div class="input-group">
                                        <input readonly class="form-control text-end" id="bufferedEnergyValue" readonly>
                                        <span class="input-group-text">€</span>
                                    </div>
                                </div>
                            </div>
                        </div>  

                        <h5 class="mb-3">Economic Calculations</h5>
                        <div class="row">
                            <div class="col-md-3">
                                <div class="mb-3">
                                    <label for="totalSystemCost" class="form-label">Total System Cost</label>
                                    <div class="input-group">
                                        <input readonly class="form-control text-end" id="totalSystemCost" readonly>
                                        <span class="input-group-text">€</span>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="mb-3">
                                    <label for="dailySaving" class="form-label">Daily Saving</label>
                                    <div class="input-group">
                                        <input readonly class="form-control text-end" id="dailySaving" readonly>
                                        <span class="input-group-text">€</span>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">Estimated ROI</label>
                                    <div class="row mb-2"><div class="col-8"><input class="form-control" id="roiMonths" readonly></div>
                                    <div class="col-4"><input class="form-control" id="roiDays" readonly></div></div>
                                </div>
                            </div>
                        </div>
                </div>
            </div>

            
        </form>
    </div>

    <!-- Bootstrap JS and dependencies -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
function populateFromURL() {
    const urlParams = new URLSearchParams(window.location.search);
    
    // Map of parameter names to input field IDs
    const paramMap = {
        'inverterEfficiency': 'inverterEfficiency',
        'inverterPrice': 'inverterPrice',
        'batteryEfficiency': 'batteryEfficiency',
        'batteryCapacity': 'batteryCapacity',
        'batteryPrice': 'batteryPrice',
        'wiringEfficiency': 'wiringEfficiency',
        'otherCost': 'otherCost',
        'systemUsageFactor': 'systemUsageFactor',
        'nightCost': 'nightCost',
        'dailyCost': 'dailyCost',
        'avgDailyProduction': 'avgDailyProduction',
        'pvPrice': 'pvPrice',
        'pvBuffering': 'pvBuffering',
        'scenario': 'scenario'
    };

    // Populate fields if parameters exist
    for (const [param, elementId] of Object.entries(paramMap)) {
        const value = urlParams.get(param);
        if (value !== null) {
            document.getElementById(elementId).value = value;
        }
    }

    // If any parameters were provided, calculate results
    if (urlParams.toString()) {
        calculate();
    }
}

document.addEventListener('DOMContentLoaded', populateFromURL);

function calculate() {
    // Get all the values first
    inverterEfficiency = Number(document.getElementById("inverterEfficiency").value);
    inverterPrice = Number(document.getElementById("inverterPrice").value);
    batteryEfficiency = Number(document.getElementById("batteryEfficiency").value);
    batteryCapacity = Number(document.getElementById("batteryCapacity").value);
    batteryPrice = Number(document.getElementById("batteryPrice").value);
    wiringEfficiency = Number(document.getElementById("wiringEfficiency").value);
    otherCost = Number(document.getElementById("otherCost").value);
    nightCost = Number(document.getElementById("nightCost").value);
    dailyCost = Number(document.getElementById("dailyCost").value);
    avgDailyProduction = Number(document.getElementById("avgDailyProduction").value);
    pvPrice = Number(document.getElementById("pvPrice").value);
    pvBuffering = Number(document.getElementById("pvBuffering").value);
    scenario = document.getElementById("scenario").value;

    // Update URL with current values
    const params = new URLSearchParams({
        inverterEfficiency,
        inverterPrice,
        batteryEfficiency,
        batteryCapacity,
        batteryPrice,
        wiringEfficiency,
        otherCost,
        nightCost,
        dailyCost,
        avgDailyProduction,
        pvPrice,
        pvBuffering,
        scenario
    });
    
    const newUrl = `${window.location.pathname}?${params.toString()}`;
    window.history.pushState({}, '', newUrl);

    // Efficiency
    singleTripEfficiency = inverterEfficiency * batteryEfficiency * wiringEfficiency;
    roundTripEfficiency = singleTripEfficiency * singleTripEfficiency;

    singleTripEfficiency = Number(singleTripEfficiency.toFixed(3));
    roundTripEfficiency = Number(roundTripEfficiency.toFixed(3));

    document.getElementById("singleTripEfficiency").value = singleTripEfficiency;
    document.getElementById("roundTripEfficiency").value = roundTripEfficiency;

    // Energy stored in the battery
    energyToLoad = batteryCapacity / singleTripEfficiency;
    document.getElementById("energyToLoad").value = (energyToLoad).toFixed(3);

    costToLoad = (energyToLoad) * nightCost;
    document.getElementById("costToLoad").value = costToLoad.toFixed(2);

    // Usable energy
    usableEnergy = batteryCapacity * singleTripEfficiency;
    document.getElementById("usableEnergy").value = (usableEnergy).toFixed(3);

    // Cost of the usable energy
    valueUsableEnergy = (usableEnergy) * dailyCost;
    document.getElementById("valueUsableEnergy").value = valueUsableEnergy.toFixed(2);

    // Buffered energy
    bufferedEnergy = Math.min(avgDailyProduction * (pvBuffering / 100) * singleTripEfficiency, batteryCapacity);
    document.getElementById("bufferedEnergy").value = bufferedEnergy.toFixed(3);

    usableBufferedEnergy = bufferedEnergy * singleTripEfficiency;
    document.getElementById("usableBufferedEnergy").value = usableBufferedEnergy.toFixed(3);

        // Buffered energy value
    bufferedEnergyValue = usableBufferedEnergy * dailyCost;
    document.getElementById("bufferedEnergyValue").value = bufferedEnergyValue.toFixed(2);

    // Daily saving
    dailySaving = valueUsableEnergy - costToLoad;
    dailySaving = dailySaving + bufferedEnergyValue;
    document.getElementById("dailySaving").value = dailySaving.toFixed(2);

    // ROI
    totalSystemCost = inverterPrice + batteryPrice + otherCost + pvPrice;
    document.getElementById("totalSystemCost").value = totalSystemCost.toFixed(2);
    daysToPay = Math.floor(totalSystemCost / (dailySaving));

    // Convert days to years, months, and days
    roiYears = Math.floor(daysToPay / 365);
    remainingDays = daysToPay % 365;
    roiMonths = Math.floor(remainingDays / 30);
    roiDays = Math.floor(remainingDays % 30);
    document.getElementById("roiMonths").value = roiYears + " years " + roiMonths + " months " + roiDays + " days";
    document.getElementById("roiDays").value = daysToPay + " days";
}




function changeScenario() {
    scenario = document.getElementById("scenario").value;
    switch(scenario) {
        case "1":
            // Battery only
            document.getElementById("inverterEfficiency").value = 0.93;
            document.getElementById("inverterPrice").value = 1000;
            document.getElementById("batteryEfficiency").value = 0.95;
            document.getElementById("batteryCapacity").value = 10;
            document.getElementById("batteryPrice").value = 2000;
            document.getElementById("wiringEfficiency").value = 0.99;
            document.getElementById("otherCost").value = 500;
            document.getElementById("nightCost").value = 0.14301;
            document.getElementById("dailyCost").value = 0.26378;
            document.getElementById("avgDailyProduction").value = 0;
            document.getElementById("pvPrice").value = 0;
            document.getElementById("pvBuffering").value = 0;
            break;
        case "2":
            // Battery + PV 1
            document.getElementById("inverterEfficiency").value = 0.93;
            document.getElementById("inverterPrice").value = 1000;
            document.getElementById("batteryEfficiency").value = 0.95;
            document.getElementById("batteryCapacity").value = 10;
            document.getElementById("batteryPrice").value = 2000;
            document.getElementById("wiringEfficiency").value = 0.99;
            document.getElementById("otherCost").value = 500;
            document.getElementById("nightCost").value = 0.14301;
            document.getElementById("dailyCost").value = 0.26378;
            document.getElementById("avgDailyProduction").value = 10;
            document.getElementById("pvPrice").value = 0;
            document.getElementById("pvBuffering").value = 50;
            break;
        case "3":
            // Battery + PV 2
            document.getElementById("inverterEfficiency").value = 0.93;
            document.getElementById("inverterPrice").value = 1000;
            document.getElementById("batteryEfficiency").value = 0.95;
            document.getElementById("batteryCapacity").value = 10;
            document.getElementById("batteryPrice").value = 2000;
            document.getElementById("wiringEfficiency").value = 0.99;
            document.getElementById("otherCost").value = 500;
            document.getElementById("nightCost").value = 0.14301;
            document.getElementById("dailyCost").value = 0.26378;
            document.getElementById("avgDailyProduction").value = 10;
            document.getElementById("pvPrice").value = 0;
            document.getElementById("pvBuffering").value = 100;
            break;
    }
}



    </script>
</body>
</html>


